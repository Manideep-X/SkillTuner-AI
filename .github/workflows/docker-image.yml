name: Docker Image Continuous Integration

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  build:

    runs-on: ubuntu-latest

    permissions:
      contents: read # allows to read the repo code
      packages: write # write permission is needed to push to GHCR
      id-token: write # allow OpenID connection authentication

    steps:
    - name: Get all codes from the repo
      uses: actions/checkout@v4 # downloads the repo codes to the runner's file system

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }} # username of the user who has this workflow
        password: ${{ github.token }} # auto-generated by GitHub
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: docker.io
        username: ${{ secrets.DOCKERHUB_USERNAME }} # username of the Docker Hub account
        password: ${{ secrets.DOCKERHUB_ACCESS_TOKEN }} # manually generated from Docker Hub

    - name: Convert my username to lowercase
      id: vars # it assigns an identifier to the output, so later steps can access it.
      # owner_lowerc is a GitHub action output variable which converts the string value inside the variable to lowercase using Bash parameter expansion.
      run: echo "owner_lowerc=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_OUTPUT

      # More Bash operators:
      #   ${VAR^^} → uppercase
      #   ${VAR,,} → lowercase
      #   ${VAR~} → capitalize first letter
      #   ${VAR,} → lowercase first letter

    - name: Set up Docker Buildx for caching
      uses: docker/setup-buildx-action@v3

    - name: Build and Push the Docker image with cache
      uses: docker/build-push-action@v5
      with:
        context: . # all files in this current directory will be send to Docker for building image
        push: true # will automatically push the image to the registries after building it
        tags: |
          ghcr.io/${{ steps.vars.outputs.owner_lowerc }}/skilltuner-ai:latest
          ghcr.io/${{ steps.vars.outputs.owner_lowerc }}/skilltuner-ai:0.1
          docker.io/${{ secrets.DOCKERHUB_USERNAME }}/skilltuner-ai:latest
          docker.io/${{ secrets.DOCKERHUB_USERNAME }}/skilltuner-ai:0.1
        cache-from: type=gha # load cached layers from GitHub Action Storage(if available)
        cache-to: type=gha,mode=max # save/update caches layer to GitHub Action Storage
