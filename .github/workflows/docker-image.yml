name: Docker Image Continuous Integration

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  build:

    runs-on: ubuntu-latest

    permissions:
      contents: read # allows to read the repo code
      packages: write # write permission is needed to push to GHCR
      id-token: write # allow OpenID connection authentication

    steps:
    - name: Get all codes from the repo
      uses: actions/checkout@v4 # downloads the repo codes to the runner's file system

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }} # username of the user who has this workflow
        password: ${{ github.token }} # auto-generated by GitHub
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: docker.io
        username: ${{ secrets.DOCKERHUB_USERNAME }} # username of the Docker Hub account
        password: ${{ secrets.DOCKERHUB_ACCESS_TOKEN }} # manually generated from Docker Hub

    - name: Convert my username to lowercase
      id: vars # it assigns an identifier to the output, so later steps can access it.
      # owner_lowerc is a GitHub action output variable which converts the string value inside the variable to lowercase using Bash parameter expansion.
      run: echo "owner_lowerc=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_OUTPUT

      # More Bash operators:
      #   ${VAR^^} → uppercase
      #   ${VAR,,} → lowercase
      #   ${VAR~} → capitalize first letter
      #   ${VAR,} → lowercase first letter
      
    - name: Build the Docker image # Both the initial beta version and the latest version are added
      run: |
        docker build . \
          -t ghcr.io/${{ steps.vars.outputs.owner_lowerc }}/skilltuner-ai:latest \
          -t ghcr.io/${{ steps.vars.outputs.owner_lowerc }}/skilltuner-ai:0.1 \
          -t ${{ secrets.DOCKERHUB_USERNAME }}/skilltuner-ai:latest \
          -t ${{ secrets.DOCKERHUB_USERNAME }}/skilltuner-ai:0.1

    - name: Push image to GHCR
      run: |
        docker push ghcr.io/${{ steps.vars.outputs.owner_lowerc }}/skilltuner-ai:latest
        docker push ghcr.io/${{ steps.vars.outputs.owner_lowerc }}/skilltuner-ai:0.1
          
    - name: Push image to Docker Hub
      run: |
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/skilltuner-ai:latest
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/skilltuner-ai:0.1
